When triaging malware:
1. identify point of entry
2. what are the indicators of the malware execution? C2 comms, file or process creation
3. What does it do? What's the objective?
4. How can we defang it or disarm it.

[Targeted malware campaign:](https://www.kaspersky.co.uk/resource-center/threats/darkhotel-malware-virus-threat-definition)

https://www.avast.com/c-eternalblue
Just a quick recap on the iconic **WannaCry**
1. NSA develops a tool to abuse SMBv1 vuln
2. Shadow Broker group finds and exfiltrates the exploit
3. The EternalBlue vuln then used to distribute WannaCry across the world

Ransomware-as-a-service:
https://www.malwarebytes.com/blog/detections/ransom-cerber


Signature analysis via checksums is #StaticAnalysis which is analysing the malware without executing the code. 

Some #StaticAnalysis tools
- Dependency Walker (depends)
- PeID
- **PE Explorer**
- PEview
- ResourceHacker
- IDA Freeware
- WinDbg
- ResourceHacker

	A windows tool for showing file hashes in the explorer tab.
[[http://implbits.com/products/hashtab/]]

Files have identifying attributes in their hex
The hex value for an executable is always "**4D 5A**". If a file with a "**.jpg**" file has the hex header of "**4D 5A**", it could be obfuscated. 

Handy tool to analyse BTC wallet transactions:
https://live.blockcypher.com/

Malware rooms:

`peepdf` is part of the [REMnux](https://remnux.org/) distro.

REMnux is quite the tool, best to be used a separate distro.



`peepdf` will output some useful details by default:
```
MD5: 2992490eb3c13d8006e8e17315a9190e
SHA1: 75884015d6d984a4fcde046159f4c8f9857500ee
SHA256: 83fefd2512591b8d06cda47d56650f9cbb75f2e8dbe0ab4186bf4c0483ef468a
Size: 28891 bytes
Version: 1.7
Binary: True
Linearized: False
Encrypted: False
Updates: 0
Objects: 18
Streams: 3
URIs: 0
Comments: 0
Errors: 0

Version 0:
        Catalog: 1
        Info: 7
        Objects (18): [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]
        Streams (3): [4, 15, 18]
                Encoded (2): [15, 18]
        Objects with JS code (1): [6]
        Suspicious elements:
                /OpenAction (1): [1]
                /JS (1): [6]
                /JavaScript (1): [6]
```

you can extract the .js from the file via:
```
echo 'extract js > javascript-from-demo_notsuspicious.pdf' > extracted_javascript.txt
```


```

remnux@thm-remnux:~/Tasks/3$ cat extracted_javascript.txt
extract js > javascript-from-demo_notsuspicious.pdf

emnux@thm-remnux:~/Tasks/3$ peepdf -s extracted_javascript.txt notsuspicious.pdf
# run the script txt peepdf

remnux@thm-remnux:~/Tasks/3$ ls
advert.pdf  extracted_javascript.txt  ext.txt  javascript-from-demo_notsuspicious.pdf  notsuspicious.pdf

remnux@thm-remnux:~/Tasks/3$ cat javascript-from-demo_notsuspicious.pdf
// peepdf comment: Javascript code located in object 6 (version 0)

app.alert("placeholder-for-flag");remnux@thm-remnux:~/Tasks/3$
```

When it comes to scripts/ macros in Office products, *vmonkey*, part of the REMnux toolset comes handy:
```
remnux@thm-remnux:~/Tasks/4$ vmonkey DefinitelyALegitInvoice.doc
```


Malware authors use techniques that increase the entropy of a file. Entropy is a good indicator of dodgy business going on. 

Entry point -> Unpacking Stub -> entry point back, begin execution 

To check if an executable was packed: PEID, loook at size, UPX value, entropy. (scale 1 to 8)
UPX is a common packer.

Emotet, Ryuk and Qakbot are some APTs using MS Macros 

# Friday Overtime Analyst Room

## Situation Overview

It's a Friday evening at PandaProbe Intelligence when a notification appears on your CTI platform. SwiftSpend Finance has opened a new ticket, raising concerns about potential malware threats. As the only remaining CTI Analyst on shift, you're tasked with analyzing multiple file attachments presumed to be malware samples.

## Investigation Q&A

**Q: Who shared the malware samples?**

A: Check the email on the internal SOC platform)

**Q: What is the SHA1 hash of the file "pRsm.dll" inside samples.zip?**

A: Use the command `sha1sum ./pRsm.dll` in the samples directory

**Q: Which malware framework utilizes these DLLs as add-on modules?**

A: 
Certainly. Here's the formatted version with markdown, keeping the original text and removing the "answer to be filled" and note sections:
Friday Overtime Analyst Room
Situation Overview

It's a Friday evening at PandaProbe Intelligence when a notification appears on your CTI platform. SwiftSpend Finance has opened a new ticket, raising concerns about potential malware threats. As the only remaining CTI Analyst on shift, you're tasked with analyzing multiple file attachments presumed to be malware samples.
Investigation Q&A

Q: Who shared the malware samples?

Part of the email on the internal SOC platform.

Q: What is the SHA1 hash of the file "pRsm.dll" inside samples.zip?

[ericatracy@ip-10-10-63-55 samples]$ sha1sum ./pRsm.dll

Q: Which malware framework utilizes these DLLs as add-on modules?
Crossreferenced the previous sha1 sum with virustotal.
Two articles show up in the community tab, as this is a real life scenario:
https://symantec-enterprise-blogs.security.com/threat-intelligence/apt-attacks-telecoms-africa-mgbot

https://www.welivesecurity.com/2023/04/26/evasive-panda-apt-group-malware-updates-popular-chinese-software/

plugged in these sites into Perplexity.ai for a summary:
Key Malware Features and Behavior:

    MgBot is written in C++ with an object-oriented design and can communicate via TCP and UDP
    It has existed since at least 2012 and was publicly documented in 2014, with little evolution since then
    MgBot's installer and backdoor DLL have not changed significantly since first documented
    It uses a chain of execution similar to what was described in a 2020 report by Malwarebytes
    MgBot has a modular architecture that allows it to extend functionality by receiving and deploying plugin modules on compromised machines Known plugin modules include:
        Keylogger (Kstrcs.dll) that logs keystrokes in the QQ chat application
        File stealer (sebasek.dll) that collects files based on criteria like filename keywords and size
        Clipboard text capture (cbmrpa.dll)
        Audio capture (pRsm.dll)
        Credential stealers for email clients, web browsers, FTP clients, etc. (mailLFPassword.dll, agentpwd.dll)
        QQ database content stealer (qmsdp.dll)
        WeChat information stealer (wcdbcrk.dll)
        Cookie stealer for Firefox, Chrome, Edge (Gmck.dll)
    The majority of plugins target popular Chinese apps like QQ, WeChat, QQBrowser, Foxmail developed by Tencent
    Evasive Panda delivered MgBot via hijacked update channels of legitimate Chinese applications in 2020-2021
    They used techniques like supply-chain compromise or adversary-in-the-middle attacks to deliver malware through the updates
    MgBot uses hardcoded URLs and IP addresses for C&C servers
    It performs UAC bypass and modifies the registry for persistence
    MgBot can inject malicious DLLs into remote processes

From a security analyst perspective, this malware exhibits advanced persistent threat (APT) characteristics. It has a modular architecture to adapt to different targets, steals sensitive data, and uses sophisticated techniques to deliver and execute itself. Defending against such targeted attacks requires robust endpoint protection, network monitoring, and incident response capabilities.

**Q: Which MITRE ATT&CK Technique is linked to using pRsm.dll in this malware framework?**

Both Perplexity and a direct search on the MITRE attack website can provide this information.

**Q: What is the CyberChef defanged URL of the malicious download location first seen on 2020-11-02?**

The ESET article details the technical breakdown of the malware, providing this information.

**Q: What is the CyberChef defanged IP address of the C&C server first detected on 2020-09-14 using these modules?**

Just as above, the C2 server is mention in the article. CyberChef is available on many sites, I've used [https://gchq.github.io/CyberChef/#recipe=Defang_IP_Addresses()&input=MTIyLjEwLjkwLjEy](https://gchq.github.io/CyberChef/#recipe=Defang_IP_Addresses()&input=MTIyLjEwLjkwLjEy)

**Q: What is the SHA1 hash of the spyagent family spyware hosted on the same IP targeting Android devices on November 16, 2022?**

Researching the C2 server IP address on abuseip.db and virustotal led to more details. The Relations tab - Communicating Files (4) field contained an Android type file with the same date. Looking further into this file, the Details tab will provide MD5, SHA1 and SHA256 sums.
