
When triaging malware:
1. identify point of entry
2. what are the indicators of the malware execution? C2 comms, file or process creation
3. What does it do? What's the objective?
4. How can we defang it or disarm it.

[Targeted malware campaign:](https://www.kaspersky.co.uk/resource-center/threats/darkhotel-malware-virus-threat-definition)

https://www.avast.com/c-eternalblue
Just a quick recap on the iconic **WannaCry**
1. NSA develops a tool to abuse SMBv1 vuln
2. Shadow Broker group finds and exfiltrates the exploit
3. The EternalBlue vuln then used to distribute WannaCry across the world

Ransomware-as-a-service:
https://www.malwarebytes.com/blog/detections/ransom-cerber


Signature analysis via checksums is #StaticAnalysis which is analysing the malware without executing the code. 

Some #StaticAnalysis tools
- Dependency Walker (depends)
- PeID
- **PE Explorer**
- PEview
- ResourceHacker
- IDA Freeware
- WinDbg
- ResourceHacker

	A windows tool for showing file hashes in the explorer tab.
[[http://implbits.com/products/hashtab/]]

Files have identifying attributes in their hex
The hex value for an executable is always "**4D 5A**". If a file with a "**.jpg**" file has the hex header of "**4D 5A**", it could be obfuscated. 

Handy tool to analyse BTC wallet transactions:
https://live.blockcypher.com/

Malware rooms:

`peepdf` is part of the [REMnux](https://remnux.org/) distro.

REMnux is quite the tool, best to be used a separate distro.



`peepdf` will output some useful details by default:
```
MD5: 2992490eb3c13d8006e8e17315a9190e
SHA1: 75884015d6d984a4fcde046159f4c8f9857500ee
SHA256: 83fefd2512591b8d06cda47d56650f9cbb75f2e8dbe0ab4186bf4c0483ef468a
Size: 28891 bytes
Version: 1.7
Binary: True
Linearized: False
Encrypted: False
Updates: 0
Objects: 18
Streams: 3
URIs: 0
Comments: 0
Errors: 0

Version 0:
        Catalog: 1
        Info: 7
        Objects (18): [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]
        Streams (3): [4, 15, 18]
                Encoded (2): [15, 18]
        Objects with JS code (1): [6]
        Suspicious elements:
                /OpenAction (1): [1]
                /JS (1): [6]
                /JavaScript (1): [6]
```

you can extract the .js from the file via:
```
echo 'extract js > javascript-from-demo_notsuspicious.pdf' > extracted_javascript.txt
```


```

remnux@thm-remnux:~/Tasks/3$ cat extracted_javascript.txt
extract js > javascript-from-demo_notsuspicious.pdf

emnux@thm-remnux:~/Tasks/3$ peepdf -s extracted_javascript.txt notsuspicious.pdf
# run the script txt peepdf

remnux@thm-remnux:~/Tasks/3$ ls
advert.pdf  extracted_javascript.txt  ext.txt  javascript-from-demo_notsuspicious.pdf  notsuspicious.pdf

remnux@thm-remnux:~/Tasks/3$ cat javascript-from-demo_notsuspicious.pdf
// peepdf comment: Javascript code located in object 6 (version 0)

app.alert("placeholder-for-flag");remnux@thm-remnux:~/Tasks/3$
```

When it comes to scripts/ macros in Office products, *vmonkey*, part of the REMnux toolset comes handy:
```
remnux@thm-remnux:~/Tasks/4$ vmonkey DefinitelyALegitInvoice.doc
```


Malware authors use techniques that increase the entropy of a file. Entropy is a good indicator of dodgy business going on. 

Entry point -> Unpacking Stub -> entry point back, begin execution 

To check if an executable was packed: PEID, loook at size, UPX value, entropy. (scale 1 to 8)
UPX is a common packer.

Emotet, Ryuk and Qakbot are some APTs using MS Macros 

---

# Friday Overtime Analyst Room

## Situation Overview

It's a late Friday evening at PandaProbe Intelligence, and just as you're about to wrap up, a critical notification pings on your CTI platform. SwiftSpend Finance has raised an urgent ticket, flagging potential malware threats in multiple file attachments. As the last CTI Analyst on shift, youâ€™re tasked with analyzing these suspicious files, determining their origins, and understanding their malicious capabilities.

Your mission is to identify the nature of the malware, its potential impact, and recommend mitigation strategies based on your findings.

## Investigation Q&A

### Q: Who shared the malware samples?

**A:** To identify the source of the malware samples, you need to check the email details provided on the internal SOC platform. This will give you context regarding the sender and any related information.

### Q: What is the SHA1 hash of the file "pRsm.dll" inside samples.zip?

**A:** The SHA1 hash can be calculated using the following command in the samples directory:

```bash
sha1sum ./pRsm.dll
```

### Q: Which malware framework utilizes these DLLs as add-on modules?

**A:** The `pRsm.dll` file is associated with the MgBot malware framework, a sophisticated toolset used by advanced persistent threat (APT) groups. MgBot's modular architecture allows it to extend its capabilities by loading various plugin modules, including those for keystroke logging, file stealing, and audio capture. This DLL, specifically, is used for audio capture on compromised machines.

**Key Features of MgBot:**
- Written in C++ with object-oriented design.
- Modular architecture supporting plugins like keyloggers, file stealers, and audio capture tools.
- Used by APT groups for targeted espionage, particularly in Chinese applications.

### Q: Which MITRE ATT&CK Technique is linked to using pRsm.dll in this malware framework?

**A:** The pRsm.dll module aligns with the MITRE ATT&CK Technique **T1123 - Audio Capture**. This technique involves capturing audio through an infected system's microphone, enabling attackers to eavesdrop on conversations.

### Q: What is the CyberChef defanged URL of the malicious download location first seen on 2020-11-02?

**A:** To find the defanged URL, refer to the technical breakdown provided in the ESET article. You can use CyberChef to defang the URL, ensuring it is safe for sharing and analysis.

**Example CyberChef Recipe:**
- Use the `Defang URL` function in CyberChef.

### Q: What is the CyberChef defanged IP address of the C&C server first detected on 2020-09-14 using these modules?

**A:** Similar to the defanged URL, the IP address of the Command and Control (C&C) server can be defanged using CyberChef. This IP was first detected on 2020-09-14 and is critical for tracking the malware's communication channels.

**CyberChef Link:**
- [CyberChef Defang IP Tool](https://gchq.github.io/CyberChef/#recipe=Defang_IP_Addresses())

### Q: What is the SHA1 hash of the SpyAgent family spyware hosted on the same IP targeting Android devices on November 16, 2022?

**A:** Research the C2 server IP address on platforms like abuseip.db and VirusTotal. The Relations tab, specifically the Communicating Files section, often reveals associated files. Upon identifying the Android spyware file, use the Details tab to extract its SHA1 hash.

---